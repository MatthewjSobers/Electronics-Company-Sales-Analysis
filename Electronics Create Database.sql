--create the database

CREATE TABLE STAGING_TABLE (
    CUSTOMER_ID INT,
    AGE INT,
    GENDER VARCHAR2(10),
    LOYALTTY_MEMBER VARCHAR2(3),
    PRODUCT_ID VARCHAR2(20),
    PRODUCT_TYPE VARCHAR2(25),
    UNIT_PRICE NUMBER(7,2),
    RATING INT NOT NULL,
    QUANTITY INT,
    TOTAL_PRICE NUMBER(10,2),
    ORDER_ID NUMBER GENERATED BY DEFAULT AS IDENTITY,
    ORDER_STATUS VARCHAR2(20),
    PAYMENT_METHOD VARCHAR2(20),
    PURCHASE_DATE DATE,
    SHIPPING_TYPE VARCHAR2(20),
    ADD_ONS_PURCHASED VARCHAR2(255),
    ADD_ON_TOTAL NUMBER(10,2)
);


CREATE TABLE CUSTOMER (
    CUSTOMER_ID INT PRIMARY KEY,
    AGE INT,
    GENDER VARCHAR2(10)
);
DROP TABLE CUSTOMER CASCADE CONSTRAINTS;

CREATE TABLE PRODUCT (
    PRODUCT_ID VARCHAR2(20) PRIMARY KEY,
    PRODUCT_TYPE VARCHAR2(25),
    UNIT_PRICE NUMBER(7,2)
);
--DROP TABLE PRODUCT CASCADE CONSTRAINTS;

CREATE TABLE ORDERS (
    ORDER_ID NUMBER PRIMARY KEY,
    CUSTOMER_ID INT,
    PRODUCT_ID VARCHAR2(20),
    QUANTITY INT,
    TOTAL_PRICE NUMBER(10,2),
    ORDER_STATUS VARCHAR2(20),
    PAYMENT_METHOD VARCHAR2(20),
    PURCHASE_DATE DATE,
    LOYALTY_MEMBER VARCHAR2(3),
    RATING INT NOT NULL,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID),
    FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT(PRODUCT_ID)
);
--DROP TABLE ORDERS CASCADE CONSTRAINTS;

CREATE TABLE SHIPPING (
    ORDER_ID NUMBER PRIMARY KEY,
    SHIPPING_TYPE VARCHAR2(20),
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID)
);
--DROP TABLE SHIPPING CASCADE CONSTRAINTS;

CREATE TABLE ADD_ONS (
    ORDER_ID NUMBER PRIMARY KEY,
    ADD_ONS_PURCHASED VARCHAR2(255),
    ADD_ON_TOTAL NUMBER(10,2),
    FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ORDER_ID)
);
--DROP TABLE ADD_ONS CASCADE CONSTRAINTS;

CREATE TABLE STAGING_TABLE_BACKUP AS
SELECT * FROM STAGING_TABLE;

--INSERTS

--Populate the customer table
INSERT INTO CUSTOMER (CUSTOMER_ID, AGE, GENDER)
SELECT DISTINCT CUSTOMER_ID, AGE, GENDER
FROM STAGING_TABLE;


--Populate the product table
INSERT INTO PRODUCT (PRODUCT_ID, PRODUCT_TYPE, UNIT_PRICE)
SELECT DISTINCT PRODUCT_ID, PRODUCT_TYPE, UNIT_PRICE 
FROM STAGING_TABLE;

--populate the orders table
INSERT INTO ORDERS (
    ORDER_ID,
    CUSTOMER_ID,
    PRODUCT_ID,
    QUANTITY,
    TOTAL_PRICE,
    ORDER_STATUS,
    PAYMENT_METHOD,
    PURCHASE_DATE,
    LOYALTY_MEMBER,
    RATING)
SELECT
    ORDER_ID,
    CUSTOMER_ID,
    PRODUCT_ID,
    QUANTITY,
    TOTAL_PRICE,
    ORDER_STATUS,
    PAYMENT_METHOD,
    PURCHASE_DATE,
    LOYALTY_MEMBER,
    RATING
FROM STAGING_TABLE;

--populate the shipping table
INSERT INTO SHIPPING (ORDER_ID, SHIPPING_TYPE)
SELECT ORDER_ID, SHIPPING_TYPE
FROM STAGING_TABLE;

--populate the add_ons table
INSERT INTO ADD_ONS (ORDER_ID, ADD_ONS_PURCHASED, ADD_ON_TOTAL)
SELECT ORDER_ID, ADD_ONS_PURCHASED, ADD_ON_TOTAL
FROM STAGING_TABLE;

